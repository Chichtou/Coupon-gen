{% extends "base.html" %}
{% block title %}Validate Coupon{% endblock %}
{% block content %}
<h2>Validate a Coupon</h2>

<form method="post" id="validateForm">
  <div>
    <label for="code">Coupon Code:</label>
    <input type="text" name="code" id="couponInput" required>
  </div>
  <!-- Inline the Validate button and the Scan button in the same row -->
  <div class="button-row">
    <input type="submit" value="Validate Coupon">
    <button id="startScan" class="camera-button" title="Scan Coupon">
      Scan
    </button>
  </div>
</form>

<div id="reader" style="width:300px; margin-top:10px;"></div>

{% if message %}
  {% if "valid" in message %}
    <div class="alert-success">{{ message }}</div>
  {% elif "redeemed" in message or "expired" in message %}
    <div class="alert-error">{{ message }}</div>
  {% else %}
    <div class="alert-info">{{ message }}</div>
  {% endif %}
{% endif %}

<!-- Include html5-qrcode library from CDN -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const startScanButton = document.getElementById('startScan');
  const couponInput = document.getElementById('couponInput');
  const readerElement = document.getElementById('reader');

  startScanButton.addEventListener('click', () => {
    // Hide the button when scanning starts (optional)
    startScanButton.style.display = 'none';

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: 250 };

    html5QrCode.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
          // On successful scan, fill the input and submit the form.
          couponInput.value = decodedText;
          html5QrCode.stop().then(() => {
              readerElement.innerHTML = "";
              document.getElementById('validateForm').submit();
          }).catch(err => {
              console.error("Error stopping scanner", err);
          });
      },
      (errorMessage) => {
          console.warn("Scan error:", errorMessage);
      }
    ).catch(err => {
      console.error("Unable to start scanning.", err);
    });
  });
</script>
{% endblock %}
